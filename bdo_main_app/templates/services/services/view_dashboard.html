{% extends 'base.html' %}

{% load static %}

{% block css %}

    <link rel="stylesheet" href={% static '/css/angular-gridster.css' %}/>
    <style>
        #loadImg{position:absolute;z-index:999;}
        #loadImg {display:table-cell;width:100%;height:300px;background:#fff;text-align:center;vertical-align:middle;}

        #dynamic_dashboard iframe{
            background-color: white;
            height: 96%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .loadingFrame{position:absolute;z-index:999;display:block;right:0;left:0;bottom:0;top:0;background:#fff;text-align:center;border:thin dashed;}


     {#Dashboard Additions#}
        .gridster .gridster-item {
            -webkit-box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            -moz-box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            color: #004756;
            background: white;
            padding: 0px;
        }
        ul {
            list-style: none;
        }

        .wrap1{
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 100000;
            opacity: 0;
            display: none;
        }

        .deletebtn{
            position: absolute;
            right: 0;
            top: 0;
            background: #2172ac url('/static/img/exitBtn.png') center ;
            height: 37px;
            border: none;
            color: white;
            width: 30px;
        }

        .deletebtn:hover{
            background-color: red;
            cursor: pointer;
        }

        .iframe1{
            height: 90%;
            width: 100%;
        }

        .iframeHeader{
            height: 37px;
            width: 100%;
            background-color: #30526a;
            text-align: center;
        }

        .iframe-class{
            height: calc(100% - 37px)!important;
            padding: 0px;
            margin: 0% 0% 0% 0% !important;
        }


        .iframeHeader .form-group{
            margin: 0px 0px 0px 0px !important;
        }

        .iframeHeader .form-group .form-control{
            color: #FFFFFF;
        }

        #scroll_down_area{
            display: none;
            width: 100%;
            height: 30%;
            position: absolute;
            bottom: 0;
            z-index: 100000;
            opacity: 100;
            {#background-color: #0b2e13;#}
            display: none;

        }

        .widget-title{
            padding-top: 4px;
            padding-left: 2px;
            font-size: 150%;
            color: white;

        }

        .modal-tab{
            width:50%;
            height: 30px;
            background-color: #2172ac;
            color: white;
            float: left;
            box-shadow: 0px -1px 5px grey;
            border-bottom: 1px solid black;
        }

        .modal-tab:hover{
            cursor: pointer;
        }

        #modal-tab-data{
            border-right: 1px solid black;
        }

        #modal-tab-notes{
            background-color: #617b8e;
        }

        .note_wrapper{
            padding: 10px;
            width: 100%;
            height: calc(100% - 37px);
            overflow: auto;
        }

        .ng-wrapper{
            width: 100%;
            height: calc(100%);
            display: block;
        }

         .iframeHeaderNote{
            background-color: #FFFFFF;
        }

        .titleNote{
            display: none;
        }
    </style>
{% endblock %}

{% block content %}

    <h1 class="text-center">{{ dashboard.title }}</h1>
     <div ng-app="myApp" ng-controller="MainCtrl">
        <div id="dynamic_dashboard" gridster="gridsterOpts">
            <ul id="widgetParent">
                <li id="widget[[::counter]]" gridster-item="item" ng-repeat="item in standardItems">
                    <div class='wrap1'></div>
                    <header class="iframeHeader" ng-class="{'iframeHeaderNote': item.url == ''}">
                        <p class="widget-title" ng-class="{'titleNote': item.url == ''}" ng-bind="item.title"> </p>
                    </header>
                    <div ng-class="{'ng-wrapper': item.noteData == ''}" ng-switch="!!item.noteData" style="displa: none">
                        <div class="ng-wrapper" ng-switch-when="false">
                            <div class="loadingFrame"><img src="{% static 'img/loading_gif.gif' %}"/></div>
                            <iframe  class="iframe-class" src=[[item.url]] frameborder='0' onLoad="hideGif( this, event )"></iframe>
                        </div>
                    </div>
                    <div  ng-class="{'ng-wrapper': item.url == '' }" ng-switch="!!item.url" style="displa: none">
                        <div class="ng-wrapper" ng-switch-when="false" ng-bind-html="[[item.noteData]]">
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>

{% endblock %}


{% block modal %}

{% endblock %}

{% block js %}
    <script type="text/javascript" src={% static '/js/angular.js' %}></script>
    <script type="text/javascript" src={% static '/js/angular-gridster.min.js' %}></script>
    <script type="text/javascript" src={% static '/js/jquery.resize.js' %}></script>
    <script type="text/javascript" src={% static '/js/angular-sanitize.min.js' %}></script>


<script type="text/javascript">
        var app = angular.module('myApp', ['gridster' , 'ngSanitize']);

        {# Angular and django conflict with same symbols {{}} replace angular with [[]] #}
        app.config(function ($interpolateProvider) {
            $interpolateProvider.startSymbol('[[');
            $interpolateProvider.endSymbol(']]');
        });

        {#Angular app setup#}
        app.controller('MainCtrl', function ($scope) {
            {#Declaring global variables used later#}
            $scope.counter = "0";
            $scope.tempInnerHtml="";
            {#$scope.iframeSource="";#}

            {#Angular gidster setup#}
            $scope.gridsterOpts = {
                {#Margins between the widgets#}
                margins: [20, 20],
                swapping: false,
                outerMargin: false,
                pushing: true,
                floating: true,
                columns: 6,
                defaultSizeX: 6,
	            defaultSizeY: 2,
                rowHeight: 200,
                draggable: {
                    enabled: false,
                    handle: '.iframeHeader',
                    start: function (e, ui, $widget) {
                        $('#scroll_down_area').show();
                        $('.wrap1').show();
                    },
                    stop: function (e, ui, $widget) {
                        $('#scroll_down_area').hide();
                        $('.wrap1').hide();
                    }
                },
                resizable: {
                    enabled: false,
                    handles: ['se', 'sw'],
                    start: function (e, ui, $widget) {
                        $('.wrap1').show();
                    }
                    ,
                    stop: function (e, ui, $widget) {
                        $('.wrap1').hide();
                    }
                },
            };

            {#List where widgets are kept with their data#}
            $scope.standardItems = [];

            {#Clear list of items#}
            $scope.clear = function () {
                $scope.standardItems = [];
            };

            {#Remove specific item from the list#}
            $scope.removeWidget = function (item) {
                var index = $scope.standardItems.indexOf(item);
                $scope.standardItems.splice(index, 1);
            };


            {#Initializing widgets from database and setting content#}
            var init = function (){
                 {% for order, url in dashboard.viz_components.items %}
                     var tempinfo= "{{ url }}";
                     tempinfo=tempinfo.replace(/u&#39;/g,"");
                     tempinfo=tempinfo.replace(/&#39;/g,"");
                     tempinfo=tempinfo.replace("[","");
                     tempinfo=tempinfo.replace("]","");
                     var info = tempinfo.split(",");

                    $scope.counter++;
                    var tempid="widget" + $scope.counter;
                    {#$scope.iframeSource = info[0];#}
                     var noteDataEncoded = info[5];
                     var noteDataDecoded= $('<textarea/>').html(noteDataEncoded).text();
                     noteDataDecoded= noteDataDecoded.substr(1);
                     if(noteDataDecoded.charAt(0)=="u"){
                         if(noteDataDecoded.charAt(1)=="\""){
                             noteDataDecoded= noteDataDecoded.substr(2);
                         }
                     }
                     noteDataDecoded= noteDataDecoded.slice(0 ,-1);
                     {#noteDataDecode=noteDataDecode.encode("utf-8");#}
                    $scope.standardItems.push({sizeX:info[1], sizeY:info[2],row:info[3],col:info[4],url:info[0] ,noteData: noteDataDecoded ,title:info[6]});

                {% endfor %}
            };

            init();
        });


{#        $("iframe").on( "load", function(){#}
{#            $(this).siblings(".loadingFrame").css( "display", "none" );#}
{#        });#}

        function hideGif( elem, event ){
            $(elem).siblings(".loadingFrame").css( "display", "none" );
        }
</script>

{% endblock %}
