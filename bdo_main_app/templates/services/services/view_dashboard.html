{% extends 'base.html' %}

{% load static %}

{% block css %}
    <link rel="stylesheet" href={% static '/css/services/view_dashboard.css' %}>
{% endblock %}

{% block content %}

    <h1 class="text-center">{{ dashboard.title }}</h1>
    {% if is_owner %}
        <div class="row">
            <a href="/dashboards/edit/{{ dashboard.id }}/" class="btn btn-default btn-md pull-left bg-color--blue" style="">
                <i class="fas fa-edit"></i> Edit Dashboard
            </a>
        </div>
    {% endif %}

    <div>
         <div ng-app="myApp" ng-controller="MainCtrl">
            <div id="dynamic_dashboard" gridster="gridsterOpts">
                <ul id="widgetParent">
                    <li id="widget[[::counter]]" gridster-item="item" ng-repeat="item in standardItems">
                        <div class='wrap1'></div>
                        <header class="iframeHeader" ng-class="{'iframeHeaderNote': item.url == ''}">
                            <p class="widget-title" ng-class="{'titleNote': item.url == ''}" ng-bind="item.title"> </p>
                        </header>
                        <div ng-class="{'ng-wrapper': item.noteData == ''}" ng-switch="!!item.noteData" >
                            <div class="ng-wrapper" ng-switch-when="false">
                                <div class="loadingFrame"><img src="{% static 'img/loading_gif.gif' %}"/></div>
                                <iframe  class="iframe-class" src=[[item.url]] frameborder='0' onLoad="hideGif( this, event )"></iframe>
                            </div>
                        </div>
                        <div  ng-class="{'ng-wrapper': item.url == '' }" ng-switch="!!item.url" >
                            <div class="ng-wrapper" ng-switch-when="false" ng-bind-html="[[item.noteData]]">
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>


{% endblock %}


{% block modal %}

{% endblock %}

{% block js %}
    <script type="text/javascript" src={% static '/js/angular.js' %}></script>
    <script type="text/javascript" src={% static '/js/angular-gridster.min.js' %}></script>
    <script type="text/javascript" src={% static '/js/jquery.resize.js' %}></script>
    <script type="text/javascript" src={% static '/js/angular-sanitize.min.js' %}></script>


<script type="text/javascript">
        var app = angular.module('myApp', ['gridster' , 'ngSanitize']);

        {# Angular and django conflict with same symbols {{}} replace angular with [[]] #}
        app.config(function ($interpolateProvider) {
            $interpolateProvider.startSymbol('[[');
            $interpolateProvider.endSymbol(']]');
        });

        {#Angular app setup#}
        app.controller('MainCtrl', function ($scope) {
            {#Declaring global variables used later#}
            $scope.counter = "0";
            $scope.tempInnerHtml="";
            {#$scope.iframeSource="";#}

            {#Angular gidster setup#}
            $scope.gridsterOpts = {
                {#Margins between the widgets#}
                margins: [20, 20],
                swapping: false,
                outerMargin: false,
                pushing: true,
                floating: true,
                columns: 6,
                defaultSizeX: 6,
	            defaultSizeY: 2,
                rowHeight: 200,
                draggable: {
                    enabled: false,
                    handle: '.iframeHeader',
                    start: function (e, ui, $widget) {
                        $('#scroll_down_area').show();
                        $('.wrap1').show();
                    },
                    stop: function (e, ui, $widget) {
                        $('#scroll_down_area').hide();
                        $('.wrap1').hide();
                    }
                },
                resizable: {
                    enabled: false,
                    handles: ['se', 'sw'],
                    start: function (e, ui, $widget) {
                        $('.wrap1').show();
                    }
                    ,
                    stop: function (e, ui, $widget) {
                        $('.wrap1').hide();
                    }
                },
            };

            {#List where widgets are kept with their data#}
            $scope.standardItems = [];

            {#Clear list of items#}
            $scope.clear = function () {
                $scope.standardItems = [];
            };

            {#Remove specific item from the list#}
            $scope.removeWidget = function (item) {
                var index = $scope.standardItems.indexOf(item);
                $scope.standardItems.splice(index, 1);
            };


            $('#edit_btn').click(function (e) {
                var thisBoard = {{ pk }};
                window.location = "/dashboards/edit/" + thisBoard;
            }

        )

            {#Initializing widgets from database and setting content#}
            var init = function (){
                 {% for order, url in dashboard.viz_components.items %}
                     var tempinfo= "{{ url }}";
                     tempinfo = tempinfo.replace(/u&#39;/g, '"');
                     tempinfo = tempinfo.replace(/&#39;/g, '"');
                     tempinfo=tempinfo.replace(/u&quot;/,'"');
                     tempinfo=tempinfo.replace(/&quot;/,'"');
{#                     tempinfo=tempinfo.replace("[","");#}
{#                     tempinfo=tempinfo.replace("]","");#}
                     tempinfo = tempinfo.slice(1,-1);
                     var nth= 13;
                     var toslice = 0;
                     for(var i=0 ; i<tempinfo.length ;i++){
                         if(tempinfo.charAt(i) == '"'){
                             if(!--nth){
                                 toslice = i;
                             }
                         }
                     }

                     var info = tempinfo.split("," , 6);

                     tempinfo= tempinfo.slice(toslice + 1);


                    $scope.counter++;

                    var tempid="widget" + $scope.counter;
                    {#$scope.iframeSource = info[0];#}
                     var noteDataEncoded = tempinfo;
                     var noteDataDecoded= $('<textarea/>').html(noteDataEncoded).text();
                     {#noteDataDecoded= noteDataDecoded.substr(1);#}
                     {#if(noteDataDecoded.charAt(0)=="u"){#}
                     {#    if(noteDataDecoded.charAt(1)=="\""){#}
                     {#        noteDataDecoded= noteDataDecoded.substr(2);#}
                     {#    }#}
                     {# }#}
                     noteDataDecoded= noteDataDecoded.slice(0 ,-1);

                                          {#alert(noteDataDecoded);#}

                     {#noteDataDecode=noteDataDecode.encode("utf-8");#}

                     {#alert(info[0]);#}
                     for(var i=0 ; i < 6; i++)
                     {
                         if(i!= 0)
                            info[i] = info[i].slice(2,-1);
                         else
                             info[i] = info[i].slice(1,-1);
                     }
                     {#alert(info[0]);#}

                    $scope.standardItems.push({sizeX:info[1], sizeY:info[2],row:info[3],col:info[4],url:info[0] ,noteData: noteDataDecoded ,title:info[5]});
                {% endfor %}
            };

            init();
        });


{#        $("iframe").on( "load", function(){#}
{#            $(this).siblings(".loadingFrame").css( "display", "none" );#}
{#        });#}

        function hideGif( elem, event ){
            $(elem).siblings(".loadingFrame").css( "display", "none" );
        }
</script>

{% endblock %}
