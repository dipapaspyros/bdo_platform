{% extends 'base.html' %}

{% load static %}

{% block css %}

{#    <link rel="stylesheet" href={% static '/css/angular-gridster.css' %}/>#}
    <style>
        /**
         * gridster.js - v0.2.1 - 2013-10-28 * http://gridster.net
         * Copyright (c) 2013 ducksboard; Licensed MIT
         */
        .gridster {
          position: relative;
          margin: auto;
          height: 0;
        }
        .gridster > ul {
          margin: 0;
          list-style: none;
          padding: 0;
        }
        .gridster-item {
          -webkit-box-sizing: border-box;
          -moz-box-sizing: border-box;
          box-sizing: border-box;
          list-style: none;
          z-index: 2;
          position: absolute;
          display: none;
        }
        .gridster-loaded {
          -webkit-transition: height .3s;
          -moz-transition: height .3s;
          -o-transition: height .3s;
          transition: height .3s;
        }
        .gridster-loaded .gridster-item {
          display: block;
          position: absolute;
          -webkit-transition: opacity .3s, left .3s, top .3s, width .3s, height .3s;
          -moz-transition: opacity .3s, left .3s, top .3s, width .3s, height .3s;
          -o-transition: opacity .3s, left .3s, top .3s, width .3s, height .3s;
          transition: opacity .3s, left .3s, top .3s, width .3s, height .3s;
          -webkit-transition-delay: 50ms;
          -moz-transition-delay: 50ms;
          -o-transition-delay: 50ms;
          transition-delay: 50ms;
        }
        .gridster-loaded .gridster-preview-holder {
          display: none;
          z-index: 1;
          position: absolute;
          background-color: #ddd;
          border-color: #fff;
          opacity: 0.2;
        }
        .gridster-loaded .gridster-item.gridster-item-moving,
        .gridster-loaded .gridster-preview-holder {
          -webkit-transition: none;
          -moz-transition: none;
          -o-transition: none;
          transition: none;
        }
        .gridster-mobile {
          height: auto !important;
        }
        .gridster-mobile .gridster-item {
          height: auto;
          position: static;
          float: none;
        }
        .gridster-item.ng-leave.ng-leave-active {
          opacity: 0;
        }
        .gridster-item.ng-enter {
          opacity: 1;
        }
        .gridster-item-moving {
          z-index: 3;
        }
        /* RESIZE */
        .gridster-item-resizable-handler {
          position: absolute;
          font-size: 1px;
          display: block;
          z-index: 5;
        }
        .handle-se {
          cursor: se-resize;
          width: 0;
          height: 0;
          right: 1px;
          bottom: 1px;
          border-style: solid;
          border-width: 0 0 12px 12px;
          border-color: transparent;
        }
        .handle-ne {
          cursor: ne-resize;
          width: 12px;
          height: 12px;
          right: 1px;
          top: 1px;
        }
        .handle-nw {
          cursor: nw-resize;
          width: 12px;
          height: 12px;
          left: 1px;
          top: 1px;
        }
        .handle-sw {
          cursor: sw-resize;
          width: 0;
          height: 0;
          left: 1px;
          bottom: 1px;
          border-style: solid;
          border-width: 0 12px 12px 0px;
          border-color: transparent;
        }
        .handle-e {
          cursor: e-resize;
          width: 12px;
          bottom: 0;
          right: 1px;
          top: 0;
        }
        .handle-s {
          cursor: s-resize;
          height: 12px;
          right: 0;
          bottom: 1px;
          left: 0;
        }
        .handle-n {
          cursor: n-resize;
          height: 12px;
          right: 0;
          top: 1px;
          left: 0;
        }
        .handle-w {
          cursor: w-resize;
          width: 12px;
          left: 1px;
          top: 0;
          bottom: 0;
        }
        .gridster .gridster-item:hover .gridster-box {
          border: 1.5px solid #B3B2B3;
        }
        .gridster .gridster-item:hover .handle-se {
          border-color: transparent transparent #2172ac;
        }

        .gridster .gridster-item:hover .handle-sw {
          border-color: transparent transparent #2172ac;
        }

    </style>
{#    <link rel="stylesheet" href={% static 'dashboard_builder/css/dashboard_view.css' %}/>#}
    <style>
        #loadImg{position:absolute;z-index:999;}
        #loadImg {display:table-cell;width:100%;height:300px;background:#fff;text-align:center;vertical-align:middle;}

        #dynamic_dashboard iframe{
            background-color: white;
            height: 96%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .loadingFrame{position:absolute;z-index:999;display:block;right:0;left:0;bottom:0;top:0;background:#fff;text-align:center;border:thin dashed;}


     {#Dashboard Additions#}
        .gridster .gridster-item {
            -webkit-box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            -moz-box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            color: #004756;
            background: white;
            padding: 0px;
        }
        ul {
            list-style: none;
        }

        .wrap1{
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 100000;
            opacity: 0;
            display: none;
        }

        .deletebtn{
            position: absolute;
            right: 0;
            top: 0;
            background: #2172ac url('/static/img/exitBtn.png') center ;
            height: 37px;
            border: none;
            color: white;
            width: 30px;
        }

        .deletebtn:hover{
            background-color: red;
            cursor: pointer;
        }

        .iframe1{
            height: 90%;
            width: 100%;
        }

        .iframeHeader{
            height: 37px;
            width: 100%;
            background-color: #30526a;
            text-align: center;
        }

        .iframe-class{
            height: calc(100% - 37px)!important;
            padding: 0px;
            margin: 0% 0% 0% 0% !important;
        }


        .iframeHeader .form-group{
            margin: 0px 0px 0px 0px !important;
        }

        .iframeHeader .form-group .form-control{
            color: #FFFFFF;
        }

        #scroll_down_area{
            display: none;
            width: 100%;
            height: 30%;
            position: absolute;
            bottom: 0;
            z-index: 100000;
            opacity: 100;
            {#background-color: #0b2e13;#}
            display: none;

        }

        .widget-title{
            padding-top: 4px;
            padding-left: 2px;
            font-size: 150%;
            color: white;

        }

        .modal-tab{
            width:50%;
            height: 30px;
            background-color: #2172ac;
            color: white;
            float: left;
            box-shadow: 0px -1px 5px grey;
            border-bottom: 1px solid black;
        }

        .modal-tab:hover{
            cursor: pointer;
        }

        #modal-tab-data{
            border-right: 1px solid black;
        }

        #modal-tab-notes{
            background-color: #617b8e;
        }

        .note_wrapper{
            padding: 10px;
            width: 100%;
            height: calc(100% - 37px);
            overflow: auto;
        }

        .ng-wrapper{
            width: 100%;
            height: calc(100%);
            display: block;
        }

         .iframeHeaderNote{
            background-color: #FFFFFF;
        }

        .titleNote{
            display: none;
        }

        #edit_btn{
            float: right;
            position: relative;
            right: 0px;
            bottom: 23px ;
        }
    </style>
{% endblock %}

{% block content %}

    <h1 class="text-center">{{ dashboard.title }}
{#    <button type="button" id="edit_btn" class="btn btn-lg btn-primary" >#}
{#            Edit#}
{#        </button>#}
    </h1>
     <div ng-app="myApp" ng-controller="MainCtrl">
        <div id="dynamic_dashboard" gridster="gridsterOpts">
            <ul id="widgetParent">
                <li id="widget[[::counter]]" gridster-item="item" ng-repeat="item in standardItems">
                    <div class='wrap1'></div>
                    <header class="iframeHeader" ng-class="{'iframeHeaderNote': item.url == ''}">
                        <p class="widget-title" ng-class="{'titleNote': item.url == ''}" ng-bind="item.title"> </p>
                    </header>
                    <div ng-class="{'ng-wrapper': item.noteData == ''}" ng-switch="!!item.noteData" >
                        <div class="ng-wrapper" ng-switch-when="false">
                            <div class="loadingFrame"><img src="{% static 'img/loading_gif.gif' %}"/></div>
                            <iframe  class="iframe-class" src=[[item.url]] frameborder='0' onLoad="hideGif( this, event )"></iframe>
                        </div>
                    </div>
                    <div  ng-class="{'ng-wrapper': item.url == '' }" ng-switch="!!item.url" >
                        <div class="ng-wrapper" ng-switch-when="false" ng-bind-html="[[item.noteData]]">
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>

{% endblock %}


{% block modal %}

{% endblock %}

{% block js %}
    <script type="text/javascript" src={% static '/js/angular.js' %}></script>
    <script type="text/javascript" src={% static '/js/angular-gridster.min.js' %}></script>
    <script type="text/javascript" src={% static '/js/jquery.resize.js' %}></script>
    <script type="text/javascript" src={% static '/js/angular-sanitize.min.js' %}></script>


<script type="text/javascript">
        var app = angular.module('myApp', ['gridster' , 'ngSanitize']);

        {# Angular and django conflict with same symbols {{}} replace angular with [[]] #}
        app.config(function ($interpolateProvider) {
            $interpolateProvider.startSymbol('[[');
            $interpolateProvider.endSymbol(']]');
        });

        {#Angular app setup#}
        app.controller('MainCtrl', function ($scope) {
            {#Declaring global variables used later#}
            $scope.counter = "0";
            $scope.tempInnerHtml="";
            {#$scope.iframeSource="";#}

            {#Angular gidster setup#}
            $scope.gridsterOpts = {
                {#Margins between the widgets#}
                margins: [20, 20],
                swapping: false,
                outerMargin: false,
                pushing: true,
                floating: true,
                columns: 6,
                defaultSizeX: 6,
	            defaultSizeY: 2,
                rowHeight: 200,
                draggable: {
                    enabled: false,
                    handle: '.iframeHeader',
                    start: function (e, ui, $widget) {
                        $('#scroll_down_area').show();
                        $('.wrap1').show();
                    },
                    stop: function (e, ui, $widget) {
                        $('#scroll_down_area').hide();
                        $('.wrap1').hide();
                    }
                },
                resizable: {
                    enabled: false,
                    handles: ['se', 'sw'],
                    start: function (e, ui, $widget) {
                        $('.wrap1').show();
                    }
                    ,
                    stop: function (e, ui, $widget) {
                        $('.wrap1').hide();
                    }
                },
            };

            {#List where widgets are kept with their data#}
            $scope.standardItems = [];

            {#Clear list of items#}
            $scope.clear = function () {
                $scope.standardItems = [];
            };

            {#Remove specific item from the list#}
            $scope.removeWidget = function (item) {
                var index = $scope.standardItems.indexOf(item);
                $scope.standardItems.splice(index, 1);
            };


            $('#edit_btn').click(function (e) {
                var thisBoard = {{ pk }};
                window.location = "/dashboards/edit/" + thisBoard;
            }

        )

            {#Initializing widgets from database and setting content#}
            var init = function (){
                 {% for order, url in dashboard.viz_components.items %}
                     var tempinfo= "{{ url }}";
                     tempinfo = tempinfo.replace(/u&#39;/g, '"');
                     tempinfo = tempinfo.replace(/&#39;/g, '"');
                     tempinfo=tempinfo.replace(/u&quot;/,'"');
                     tempinfo=tempinfo.replace(/&quot;/,'"');
{#                     tempinfo=tempinfo.replace("[","");#}
{#                     tempinfo=tempinfo.replace("]","");#}
                     tempinfo = tempinfo.slice(1,-1);
                     var nth= 13;
                     var toslice = 0;
                     for(var i=0 ; i<tempinfo.length ;i++){
                         if(tempinfo.charAt(i) == '"'){
                             if(!--nth){
                                 toslice = i;
                             }
                         }
                     }

                     var info = tempinfo.split("," , 6);

                     tempinfo= tempinfo.slice(toslice + 1);


                    $scope.counter++;

                    var tempid="widget" + $scope.counter;
                    {#$scope.iframeSource = info[0];#}
                     var noteDataEncoded = tempinfo;
                     var noteDataDecoded= $('<textarea/>').html(noteDataEncoded).text();
                     {#noteDataDecoded= noteDataDecoded.substr(1);#}
                     {#if(noteDataDecoded.charAt(0)=="u"){#}
                     {#    if(noteDataDecoded.charAt(1)=="\""){#}
                     {#        noteDataDecoded= noteDataDecoded.substr(2);#}
                     {#    }#}
                     {# }#}
                     noteDataDecoded= noteDataDecoded.slice(0 ,-1);

                                          {#alert(noteDataDecoded);#}

                     {#noteDataDecode=noteDataDecode.encode("utf-8");#}

                     {#alert(info[0]);#}
                     for(var i=0 ; i < 6; i++)
                     {
                         if(i!= 0)
                            info[i] = info[i].slice(2,-1);
                         else
                             info[i] = info[i].slice(1,-1);
                     }
                     {#alert(info[0]);#}

                    $scope.standardItems.push({sizeX:info[1], sizeY:info[2],row:info[3],col:info[4],url:info[0] ,noteData: noteDataDecoded ,title:info[5]});
                {% endfor %}
            };

            init();
        });


{#        $("iframe").on( "load", function(){#}
{#            $(this).siblings(".loadingFrame").css( "display", "none" );#}
{#        });#}

        function hideGif( elem, event ){
            $(elem).siblings(".loadingFrame").css( "display", "none" );
        }
</script>

{% endblock %}
