L.TimeDimension=(L.Layer||L.Class).extend({includes:L.Evented||L.Mixin.Events,initialize:function(i){L.setOptions(this,i),this._availableTimes=this._generateAvailableTimes(),this._currentTimeIndex=-1,this._loadingTimeIndex=-1,this._loadingTimeout=this.options.loadingTimeout||3e3,this._syncedLayers=[],this._availableTimes.length>0&&this.setCurrentTime(this.options.currentTime||this._getDefaultCurrentTime()),this.options.lowerLimitTime&&this.setLowerLimit(this.options.lowerLimitTime),this.options.upperLimitTime&&this.setUpperLimit(this.options.upperLimitTime)},getAvailableTimes:function(){return this._availableTimes},getCurrentTimeIndex:function(){return-1===this._currentTimeIndex?this._availableTimes.length-1:this._currentTimeIndex},getCurrentTime:function(){var i=-1;return(i=-1!==this._loadingTimeIndex?this._loadingTimeIndex:this.getCurrentTimeIndex())>=0?this._availableTimes[i]:null},isLoading:function(){return-1!==this._loadingTimeIndex},setCurrentTimeIndex:function(i){var e=this._upperLimit||this._availableTimes.length-1,t=this._lowerLimit||0;if(!((i=Math.min(Math.max(t,i),e))<0)){this._loadingTimeIndex=i;var n=this._availableTimes[i];console.log("INIT -- Current time: "+new Date(n).toISOString()),this._checkSyncedLayersReady(this._availableTimes[this._loadingTimeIndex])?this._newTimeIndexLoaded():(this.fire("timeloading",{time:n}),setTimeout(function(i){i==this._loadingTimeIndex&&(console.log("Change time for timeout"),this._newTimeIndexLoaded())}.bind(this,i),this._loadingTimeout))}},_newTimeIndexLoaded:function(){if(-1!==this._loadingTimeIndex){var i=this._availableTimes[this._loadingTimeIndex];console.log("END -- Current time: "+new Date(i).toISOString()),this._currentTimeIndex=this._loadingTimeIndex,this.fire("timeload",{time:i}),this._loadingTimeIndex=-1}},_checkSyncedLayersReady:function(i){for(var e=0,t=this._syncedLayers.length;e<t;e++)if(this._syncedLayers[e].isReady&&!this._syncedLayers[e].isReady(i))return!1;return!0},setCurrentTime:function(i){var e=this._seekNearestTimeIndex(i);this.setCurrentTimeIndex(e)},seekNearestTime:function(i){var e=this._seekNearestTimeIndex(i);return this._availableTimes[e]},nextTime:function(i,e){i||(i=1);var t=this._currentTimeIndex,n=this._upperLimit||this._availableTimes.length-1,s=this._lowerLimit||0;this._loadingTimeIndex>-1&&(t=this._loadingTimeIndex),(t+=i)>n&&(t=e?s:n),t<s&&(t=e?n:s),this.setCurrentTimeIndex(t)},prepareNextTimes:function(i,e,t){i||(i=1);var n=this._currentTimeIndex,s=n;this._loadingTimeIndex>-1&&(n=this._loadingTimeIndex);for(var a=0,r=this._syncedLayers.length;a<r;a++)this._syncedLayers[a].setMinimumForwardCache&&this._syncedLayers[a].setMinimumForwardCache(e);for(var m=e,o=this._upperLimit||this._availableTimes.length-1,h=this._lowerLimit||0;m>0;){if((n+=i)>o){if(!t)break;n=h}if(n<h){if(!t)break;n=o}if(s===n)break;this.fire("timeloading",{time:this._availableTimes[n]}),m--}},getNumberNextTimesReady:function(i,e,t){i||(i=1);var n=this._currentTimeIndex;this._loadingTimeIndex>-1&&(n=this._loadingTimeIndex);for(var s=e,a=0,r=this._upperLimit||this._availableTimes.length-1,m=this._lowerLimit||0;s>0;){if((n+=i)>r){if(!t){s=0,a=e;break}n=m}if(n<m){if(!t){s=0,a=e;break}n=r}var o=this._availableTimes[n];this._checkSyncedLayersReady(o)&&a++,s--}return a},previousTime:function(i,e){this.nextTime(-1*i,e)},registerSyncedLayer:function(i){this._syncedLayers.push(i),i.on("timeload",this._onSyncedLayerLoaded,this)},unregisterSyncedLayer:function(i){var e=this._syncedLayers.indexOf(i);-1!=e&&this._syncedLayers.splice(e,1),i.off("timeload",this._onSyncedLayerLoaded,this)},_onSyncedLayerLoaded:function(i){i.time==this._availableTimes[this._loadingTimeIndex]&&this._checkSyncedLayersReady(i.time)&&this._newTimeIndexLoaded()},_generateAvailableTimes:function(){if(this.options.times)return L.TimeDimension.Util.parseTimesExpression(this.options.times);if(this.options.timeInterval){var i=L.TimeDimension.Util.parseTimeInterval(this.options.timeInterval),e=this.options.period||"P1D",t=this.options.validTimeRange||void 0;return L.TimeDimension.Util.explodeTimeRange(i[0],i[1],e,t)}return[]},_getDefaultCurrentTime:function(){var i=this._seekNearestTimeIndex((new Date).getTime());return this._availableTimes[i]},_seekNearestTimeIndex:function(i){for(var e=0,t=this._availableTimes.length;e<t&&!(i<this._availableTimes[e]);e++);return e>0&&e--,e},setAvailableTimes:function(i,e){var t=this.getCurrentTime(),n=this.getLowerLimit(),s=this.getUpperLimit();if("extremes"==e){var a=this.options.period||"P1D";this._availableTimes=L.TimeDimension.Util.explodeTimeRange(new Date(i[0]),new Date(i[i.length-1]),a)}else{var r=L.TimeDimension.Util.parseTimesExpression(i);if(0===this._availableTimes.length)this._availableTimes=r;else if("intersect"==e)this._availableTimes=L.TimeDimension.Util.intersect_arrays(r,this._availableTimes);else if("union"==e)this._availableTimes=L.TimeDimension.Util.union_arrays(r,this._availableTimes);else{if("replace"!=e)throw"Merge available times mode not implemented: "+e;this._availableTimes=r}}n&&this.setLowerLimit(n),s&&this.setUpperLimit(s),this.setCurrentTime(t),this.fire("availabletimeschanged",{availableTimes:this._availableTimes,currentTime:t}),console.log("available times changed")},getLowerLimit:function(){return this._availableTimes[this.getLowerLimitIndex()]},getUpperLimit:function(){return this._availableTimes[this.getUpperLimitIndex()]},setLowerLimit:function(i){var e=this._seekNearestTimeIndex(i);this.setLowerLimitIndex(e)},setUpperLimit:function(i){var e=this._seekNearestTimeIndex(i);this.setUpperLimitIndex(e)},setLowerLimitIndex:function(i){this._lowerLimit=Math.min(Math.max(i||0,0),this._upperLimit||this._availableTimes.length-1),this.fire("limitschanged",{lowerLimit:this._lowerLimit,upperLimit:this._upperLimit})},setUpperLimitIndex:function(i){this._upperLimit=Math.max(Math.min(i,this._availableTimes.length-1),this._lowerLimit||0),this.fire("limitschanged",{lowerLimit:this._lowerLimit,upperLimit:this._upperLimit})},getLowerLimitIndex:function(){return this._lowerLimit},getUpperLimitIndex:function(){return this._upperLimit}}),L.Map.addInitHook(function(){this.options.timeDimension&&(this.timeDimension=L.timeDimension(this.options.timeDimensionOptions||{}))}),L.timeDimension=function(i){return new L.TimeDimension(i)};